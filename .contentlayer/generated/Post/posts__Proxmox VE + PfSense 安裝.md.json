{
  "title": "Proxmox VE + PfSense 安裝",
  "slug": "proxmox-ve-pfsense-installation-note",
  "tags": [
    "Apps - 軟體",
    "Linux"
  ],
  "published_at": "2022-08-20T05:11:00.000Z",
  "type": "post",
  "ghost_id": "67e4c3fec5a22a00013545b7",
  "status": "published",
  "visibility": "public",
  "featured": false,
  "created_at": "2025-03-27T03:20:30.000Z",
  "updated_at": "2025-03-27T03:23:58.000Z",
  "custom_excerpt": "家中的軟路由機器本只有安裝 OpenWRT, 也稱職地工作了一段時間。偶然注意到，網路高負載的情況下，記憶體佔用也才僅 8GB 記憶體的 1% 而已。硬體資源並沒有好好被妥善使用，工程魂就燃燒起來想榨乾他。",
  "authors": [
    "Gbanyan"
  ],
  "feature_image": "../assets/photo-1544197150-b99a580bb7a8.jpg",
  "body": {
    "raw": "\n## 前言\n\n家中的軟路由機器本只有安裝 OpenWRT, 也稱職地工作了一段時間。偶然注意到，網路高負載的情況下，記憶體佔用也才僅 8GB 記憶體的 1% 而已。硬體資源並沒有好好被妥善使用，工程魂就燃燒起來想榨乾他。\n\n一種推薦配置是安裝 Proxmox VE 環境，再虛擬化 Router 軟體，剩下的資源就可以安裝其他客體作業系統如 Windows, Linux, 或者再裝 docker 服務。\n\n## Proxmox VE 安裝 pfSense\n\n安裝 Proxmox 本身的過程蠻簡單，下載 ISO 檔，燒錄到 USB 隨身碟，啟動一步一步安裝即可。在高檔硬體配置的重型伺服器，還可以考慮 ZFS 檔案系統，不過只是一台軟路由小主機就一切從簡。\n\n下載 pfSense iso 檔，上傳到 Proxmox VE，就可以安裝了。pfSense 的安裝也有不少教學文，甚至官方也有[說明文件(Virtualizing with Proxmox® VE)](https://docs.netgate.com/pfsense/en/latest/recipes/virtualize-proxmox-ve.html)。以下僅討論個人需求和架設過程中的問題。\n\n### 預計架構\n\n* 軟路由機器有四個實體網路孔, enp1s0, enp2s0, enp3s0, enp4s0\n* 第一個當作 WAN 孔，其餘三孔作為 LAN 孔\n* Proxmox VE 可以透過 LAN 孔存取\n* Proxmox VE 之下虛擬化的 pfSense 作為 Router 使用，透過 WAN 進行 PPPoE 撥號\n* 家中其餘網路設備透過 LAN 得到網路存取\n\n### 問題點\n\n* 一開始 Proxmox VE 已經建立一個 Linux Bridge, 為 vmbr0, 關聯到 enp1s0, 並已指派原先設定的 IP 192.168.100.2\n* 電腦端只能透過線路連接到 enp1s0 進行 Proxmox VE 的設定\n* 將其他實體網路接孔 enp2s0, enp3s0, enp4s0 關聯到 vmbr1\n* Pfsense 架設完成以後，可以透過 vmbr0 指定到 WAN, vmbr1 指定到 LAN，正常進行網路撥接及區域網路分派。但此一環境直接拿去使用，無法從任何已經連結到 LAN 的機器進入 Proxmox VE 管理介面\n* 接續上述，如果要進行 Proxmox VE 的管理，要整台機器拿下來，透過 enp1s0 進行連接，十分不便\n\n### 解決方法\n\n經過研究半天，還曾經一度搞到中途斷電設定黨整個丟掉無法開機的窘況，要重灌 Proxmox VE 的狀況，總算搞定了… 🤷‍♂️\n\n* 取消 vmbr0 的 預設 IP 與 Gateway，改設到 vmbr1\n* 指派 vmbr1 的 IP 設定到與 Pfsense LAN 同一網段, Gateway 指向 Pfeense 192.168.1.1\n  + pfSense 預設的 DHCP range 為 192.168.1.100 ~\n\n這樣就可以透過 Pfsense 的 LAN 孔存取 Proxmox VE 了\n\n![](../assets/ProxmoxVE_network.png)![](../assets/Proxmox.drawio.png)\n\n### 潛在問題\n\n* Proxmox VE 主機必須要透過 pfSenese 才能連到外網\n* pfSense 一旦掛掉 、遷移中停止、 或其他維護等因素，所有裝置包含 Proxmox VE 主機就有可能無法連線\n\n## pfSense vs OpenWRT\n\n以產品目標來了解發展脈絡，不一定要吵討論特定用途執優執劣\n\n### pfSense\n\n* FreeBSD 為基底，以專業防火牆目標為設計\n* 防火牆管理功能一應俱全，管理監測功能完整\n* 使用者介面條理分明，說明文字清楚\n* Netgate 公司提供商業付費支援，完善的說明文件，且有各應用場景 scene 的相對應參考文件\n\n### OpenWRT\n\n* Linux 為基礎，以小型嵌入式裝置為導向，適合硬體資源相對低的家用無線路由器\n* 小型輕量，除基本功能外，可以自行透過 opkg 安裝社群維護的套件\n* 也有說明文件，但是沒有像 Netgate 為 pfSense 維護的文件那麼使用者導向\n  + 網路相關基礎知識才能理解，或未提供細節說明，需尋找更多討論文章以尋求解答\n  + 討論文章也不一定提供正確答案，需仰賴自己摸索。\n\n我覺得兩個系統都很優秀，如果是一台無線路由器或硬體配置很低的機器要改裝，我會優先選擇 OpenWRT。但是像四核心 J1900 CPU, 記憶體裝到 8G 的機器，就會考慮裝 pfSense 來玩玩。\n\n## Reference\n\n* [在 UniFi Controller 5.9.29 啟用中華電信非固定制 IPv6 服務](https://www.jkg.tw/p1464/)\n* [pfBlockerNG设置指南 | 鐵血男兒的BLOG](https://pfschina.org/wp/?p=6505#IPv4%E6%8A%91%E5%88%B6%E5%88%97%E8%A1%A8)\n* [pfSense安装AdGuardHome | 鐵血男兒的BLOG](https://pfschina.org/wp/?p=6686)\n",
    "html": "<h2 id=\"前言\"><a href=\"#前言\">前言</a></h2>\n<p>家中的軟路由機器本只有安裝 OpenWRT, 也稱職地工作了一段時間。偶然注意到，網路高負載的情況下，記憶體佔用也才僅 8GB 記憶體的 1% 而已。硬體資源並沒有好好被妥善使用，工程魂就燃燒起來想榨乾他。</p>\n<p>一種推薦配置是安裝 Proxmox VE 環境，再虛擬化 Router 軟體，剩下的資源就可以安裝其他客體作業系統如 Windows, Linux, 或者再裝 docker 服務。</p>\n<h2 id=\"proxmox-ve-安裝-pfsense\"><a href=\"#proxmox-ve-安裝-pfsense\">Proxmox VE 安裝 pfSense</a></h2>\n<p>安裝 Proxmox 本身的過程蠻簡單，下載 ISO 檔，燒錄到 USB 隨身碟，啟動一步一步安裝即可。在高檔硬體配置的重型伺服器，還可以考慮 ZFS 檔案系統，不過只是一台軟路由小主機就一切從簡。</p>\n<p>下載 pfSense iso 檔，上傳到 Proxmox VE，就可以安裝了。pfSense 的安裝也有不少教學文，甚至官方也有<a href=\"https://docs.netgate.com/pfsense/en/latest/recipes/virtualize-proxmox-ve.html\">說明文件(Virtualizing with Proxmox® VE)</a>。以下僅討論個人需求和架設過程中的問題。</p>\n<h3 id=\"預計架構\"><a href=\"#預計架構\">預計架構</a></h3>\n<ul>\n<li>軟路由機器有四個實體網路孔, enp1s0, enp2s0, enp3s0, enp4s0</li>\n<li>第一個當作 WAN 孔，其餘三孔作為 LAN 孔</li>\n<li>Proxmox VE 可以透過 LAN 孔存取</li>\n<li>Proxmox VE 之下虛擬化的 pfSense 作為 Router 使用，透過 WAN 進行 PPPoE 撥號</li>\n<li>家中其餘網路設備透過 LAN 得到網路存取</li>\n</ul>\n<h3 id=\"問題點\"><a href=\"#問題點\">問題點</a></h3>\n<ul>\n<li>一開始 Proxmox VE 已經建立一個 Linux Bridge, 為 vmbr0, 關聯到 enp1s0, 並已指派原先設定的 IP 192.168.100.2</li>\n<li>電腦端只能透過線路連接到 enp1s0 進行 Proxmox VE 的設定</li>\n<li>將其他實體網路接孔 enp2s0, enp3s0, enp4s0 關聯到 vmbr1</li>\n<li>Pfsense 架設完成以後，可以透過 vmbr0 指定到 WAN, vmbr1 指定到 LAN，正常進行網路撥接及區域網路分派。但此一環境直接拿去使用，無法從任何已經連結到 LAN 的機器進入 Proxmox VE 管理介面</li>\n<li>接續上述，如果要進行 Proxmox VE 的管理，要整台機器拿下來，透過 enp1s0 進行連接，十分不便</li>\n</ul>\n<h3 id=\"解決方法\"><a href=\"#解決方法\">解決方法</a></h3>\n<p>經過研究半天，還曾經一度搞到中途斷電設定黨整個丟掉無法開機的窘況，要重灌 Proxmox VE 的狀況，總算搞定了… 🤷‍♂️</p>\n<ul>\n<li>取消 vmbr0 的 預設 IP 與 Gateway，改設到 vmbr1</li>\n<li>指派 vmbr1 的 IP 設定到與 Pfsense LAN 同一網段, Gateway 指向 Pfeense 192.168.1.1\n<ul>\n<li>pfSense 預設的 DHCP range 為 192.168.1.100 ~</li>\n</ul>\n</li>\n</ul>\n<p>這樣就可以透過 Pfsense 的 LAN 孔存取 Proxmox VE 了</p>\n<p><img src=\"../assets/ProxmoxVE_network.png\" alt=\"\"><img src=\"../assets/Proxmox.drawio.png\" alt=\"\"></p>\n<h3 id=\"潛在問題\"><a href=\"#潛在問題\">潛在問題</a></h3>\n<ul>\n<li>Proxmox VE 主機必須要透過 pfSenese 才能連到外網</li>\n<li>pfSense 一旦掛掉 、遷移中停止、 或其他維護等因素，所有裝置包含 Proxmox VE 主機就有可能無法連線</li>\n</ul>\n<h2 id=\"pfsense-vs-openwrt\"><a href=\"#pfsense-vs-openwrt\">pfSense vs OpenWRT</a></h2>\n<p>以產品目標來了解發展脈絡，不一定要吵討論特定用途執優執劣</p>\n<h3 id=\"pfsense\"><a href=\"#pfsense\">pfSense</a></h3>\n<ul>\n<li>FreeBSD 為基底，以專業防火牆目標為設計</li>\n<li>防火牆管理功能一應俱全，管理監測功能完整</li>\n<li>使用者介面條理分明，說明文字清楚</li>\n<li>Netgate 公司提供商業付費支援，完善的說明文件，且有各應用場景 scene 的相對應參考文件</li>\n</ul>\n<h3 id=\"openwrt\"><a href=\"#openwrt\">OpenWRT</a></h3>\n<ul>\n<li>Linux 為基礎，以小型嵌入式裝置為導向，適合硬體資源相對低的家用無線路由器</li>\n<li>小型輕量，除基本功能外，可以自行透過 opkg 安裝社群維護的套件</li>\n<li>也有說明文件，但是沒有像 Netgate 為 pfSense 維護的文件那麼使用者導向\n<ul>\n<li>網路相關基礎知識才能理解，或未提供細節說明，需尋找更多討論文章以尋求解答</li>\n<li>討論文章也不一定提供正確答案，需仰賴自己摸索。</li>\n</ul>\n</li>\n</ul>\n<p>我覺得兩個系統都很優秀，如果是一台無線路由器或硬體配置很低的機器要改裝，我會優先選擇 OpenWRT。但是像四核心 J1900 CPU, 記憶體裝到 8G 的機器，就會考慮裝 pfSense 來玩玩。</p>\n<h2 id=\"reference\"><a href=\"#reference\">Reference</a></h2>\n<ul>\n<li><a href=\"https://www.jkg.tw/p1464/\">在 UniFi Controller 5.9.29 啟用中華電信非固定制 IPv6 服務</a></li>\n<li><a href=\"https://pfschina.org/wp/?p=6505#IPv4%E6%8A%91%E5%88%B6%E5%88%97%E8%A1%A8\">pfBlockerNG设置指南 | 鐵血男兒的BLOG</a></li>\n<li><a href=\"https://pfschina.org/wp/?p=6686\">pfSense安装AdGuardHome | 鐵血男兒的BLOG</a></li>\n</ul>"
  },
  "_id": "posts/Proxmox VE + PfSense 安裝.md",
  "_raw": {
    "sourceFilePath": "posts/Proxmox VE + PfSense 安裝.md",
    "sourceFileName": "Proxmox VE + PfSense 安裝.md",
    "sourceFileDir": "posts",
    "contentType": "markdown",
    "flattenedPath": "posts/Proxmox VE + PfSense 安裝"
  },
  "__ignoredType": "Post",
  "url": "/blog/proxmox-ve-pfsense-installation-note",
  "flattenedPath": "Proxmox VE + PfSense 安裝"
}